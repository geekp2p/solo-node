version: "3.8"

services:
  # ---------- Bitcoin Core (MAINNET) ----------
  bitcoin-main:
    image: ruimarinho/bitcoin-core:latest
    container_name: bitcoind-main
    restart: unless-stopped
    volumes:
      - ${BITCOIN_MAIN_DATA_PATH:-bitcoin-main-data}:/home/bitcoin/.bitcoin
      - ./bitcoin-main:/etc/bitcoin:ro
    command: [
      "bitcoind",
      "-conf=/etc/bitcoin/bitcoin.conf",
      "-datadir=/home/bitcoin/.bitcoin",
      "-printtoconsole"
    ]
    ports:
      - "8333:8333"   # P2P mainnet
    healthcheck:
      test: ["CMD-SHELL", "bitcoin-cli -conf=/etc/bitcoin/bitcoin.conf -datadir=/home/bitcoin/.bitcoin getblockchaininfo | grep -q headers"]
      interval: 30s
      timeout: 10s
      retries: 20

  # ---------- Bitcoin Core (TESTNET) ----------
  bitcoin-testnet:
    image: ruimarinho/bitcoin-core:latest
    container_name: bitcoind-testnet
    restart: unless-stopped
    volumes:
      - ${BITCOIN_TESTNET_DATA_PATH:-bitcoin-testnet-data}:/home/bitcoin/.bitcoin
      - ./bitcoin-testnet:/etc/bitcoin:ro
    command: [
      "bitcoind",
      "-conf=/etc/bitcoin/bitcoin.conf",
      "-datadir=/home/bitcoin/.bitcoin",
      "-printtoconsole"
    ]
    ports:
      - "18333:18333"   # P2P testnet
    healthcheck:
      test: ["CMD-SHELL", "bitcoin-cli -conf=/etc/bitcoin/bitcoin.conf -datadir=/home/bitcoin/.bitcoin getblockchaininfo | grep -q headers"]
      interval: 30s
      timeout: 10s
      retries: 20

  # ---------- Stratum Proxy (MAINNET) via BFGMiner ----------
  bfgproxy-main:
    image: wernight/bfgminer:latest
    container_name: bfgminer-proxy-mainnet
    depends_on:
      bitcoin-main:
        condition: service_healthy
    restart: unless-stopped
    environment:
      TERM: xterm
    command: >
      bfgminer -S noauto -o http://${BITCOIN_MAIN_RPC_HOST:-bitcoin-main}:${BITCOIN_MAIN_RPC_PORT:-8332}
      -O ${RPC_USER:-rpcuser_main}:${RPC_PASSWORD:-rpcpass_main}
      --stratum-port 3333 --coinbase-addr ${PAYOUT_ADDRESS:-1D7VcBnYgCW6zqNP4NmdS4kia4yLGHNfw}
      --no-submit-stale
    env_file: .env
    ports:
      - "3333:3333"   # Stratum mainnet

  # ---------- Stratum Proxy (TESTNET) via BFGMiner ----------
  bfgproxy-test:
    image: wernight/bfgminer:latest
    container_name: bfgminer-proxy-testnet
    depends_on:
      bitcoin-testnet:
        condition: service_healthy
    restart: unless-stopped
    environment:
      TERM: xterm
    command: >
      bfgminer -S noauto -o http://${BITCOIN_TESTNET_RPC_HOST:-bitcoin-testnet}:${BITCOIN_TESTNET_RPC_PORT:-18332}
      -O ${RPC_USER_TESTNET:-rpcuser_test}:${RPC_PASSWORD_TESTNET:-rpcpass_test}
      --stratum-port 13333 --coinbase-addr ${PAYOUT_ADDRESS_TESTNET:-mzpJE5cWrFzGuVr1SidxEsRBDgFgPC5VmD}
      --no-submit-stale
    env_file: .env
    ports:
      - "13333:13333" # Stratum testnet

  # ---------- CKPool (MAINNET) ----------
  ckpool-main:
    build:
      context: ./ckpool
    image: local/ckpool-solo
    container_name: ckpool-solo-main
    depends_on:
      bitcoin-main:
        condition: service_healthy
    restart: unless-stopped
    env_file: .env
    command: |
      /bin/sh -c 'cat <<EOF >/tmp/ckpool.conf
      {
        "btcd": [
          {
            "url": "http://$${BITCOIN_MAIN_RPC_HOST:-bitcoin-main}:$${BITCOIN_MAIN_RPC_PORT:-8332}",
            "host": "$${BITCOIN_MAIN_RPC_HOST:-bitcoin-main}",
            "port": $${BITCOIN_MAIN_RPC_PORT:-8332},
            "user": "$${RPC_USER:-rpcuser_main}",
            "pass": "$${RPC_PASSWORD:-rpcpass_main}",
            "notify": true
          }
        ],
        "btcaddress": "$${PAYOUT_ADDRESS:-1D7VcBnYgCW6zqNP4NmdS4kia4yLGHNfw}",
        "btcsig": "/Solo via ckpool/",
        "blockpoll": 100,
        "nonce1length": 4,
        "nonce2length": 8,
        "update_interval": 30,
        "mindiff": 1,
        "startdiff": 32
      }
      EOF
      exec ckpool -E -c /tmp/ckpool.conf'
    ports:
      - "3334:3333"   # expose as 3334 (container listens 3333)

  # ---------- CKPool (TESTNET) ----------
  ckpool-test:
    build:
      context: ./ckpool
    image: local/ckpool-solo
    container_name: ckpool-solo-testnet
    depends_on:
      bitcoin-testnet:
        condition: service_healthy
    restart: unless-stopped
    env_file: .env
    command: |
      /bin/sh -c 'cat <<EOF >/tmp/ckpool.conf
      {
        "btcd": [
          {
            "url": "http://$${BITCOIN_TESTNET_RPC_HOST:-bitcoin-testnet}:$${BITCOIN_TESTNET_RPC_PORT:-18332}",
            "host": "$${BITCOIN_TESTNET_RPC_HOST:-bitcoin-testnet}",
            "port": $${BITCOIN_TESTNET_RPC_PORT:-18332},
            "user": "$${RPC_USER_TESTNET:-rpcuser_test}",
            "pass": "$${RPC_PASSWORD_TESTNET:-rpcpass_test}",
            "notify": true
          }
        ],
        "btcaddress": "$${PAYOUT_ADDRESS_TESTNET:-mzpJE5cWrFzGuVr1SidxEsRBDgFgPC5VmD}",
        "btcsig": "/Solo via ckpool/",
        "blockpoll": 100,
        "nonce1length": 4,
        "nonce2length": 8,
        "update_interval": 30,
        "mindiff": 1,
        "startdiff": 32
      }
      EOF
      exec ckpool -E -c /tmp/ckpool.conf'
    ports:
      - "13334:3333"  # expose as 13334 (container listens 3333)

volumes:
  bitcoin-main-data:
  bitcoin-testnet-data: