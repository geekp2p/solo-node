version: "3.8"

services:
  # ---------- Bitcoin Core (MAINNET) ----------
  bitcoin-main:
    image: ruimarinho/bitcoin-core:latest
    container_name: bitcoind-main
    restart: unless-stopped
    volumes:
      - ./bitcoin-main:/home/bitcoin/.bitcoin
    command: ["bitcoind","-conf=/home/bitcoin/.bitcoin/bitcoin.conf","-printtoconsole"]
    ports:
      - "8333:8333"   # P2P mainnet
    healthcheck:
      test: ["CMD", "bash", "-lc", "bitcoin-cli -conf=/home/bitcoin/.bitcoin/bitcoin.conf getblockchaininfo | grep -q headers"]
      interval: 30s
      timeout: 10s
      retries: 20

  # ---------- Bitcoin Core (TESTNET) ----------
  bitcoin-testnet:
    image: ruimarinho/bitcoin-core:latest
    container_name: bitcoind-testnet
    restart: unless-stopped
    volumes:
      - ./bitcoin-testnet:/home/bitcoin/.bitcoin
    command: ["bitcoind","-conf=/home/bitcoin/.bitcoin/bitcoin.conf","-printtoconsole"]
    ports:
      - "18333:18333" # P2P testnet
    healthcheck:
      test: ["CMD", "bash", "-lc", "bitcoin-cli -conf=/home/bitcoin/.bitcoin/bitcoin.conf -testnet getblockchaininfo | grep -q headers"]
      interval: 30s
      timeout: 10s
      retries: 20

  # ---------- Stratum Proxy (MAINNET) via BFGMiner ----------
  bfgproxy-main:
    image: wernight/bfgminer:latest
    container_name: bfgminer-proxy-main
    depends_on:
      - bitcoin-main
    restart: unless-stopped
    command: >
      bfgminer -S noauto -o http://bitcoin-main:8332 -O ${RPC_USER}:${RPC_PASSWORD}
      --stratum-port 3333 --coinbase-addr ${PAYOUT_ADDRESS}
      --no-getwork --no-monitor --no-submit-stale
    env_file: .env
    ports:
      - "3333:3333"   # Stratum mainnet

  # ---------- Stratum Proxy (TESTNET) via BFGMiner ----------
  bfgproxy-test:
    image: wernight/bfgminer:latest
    container_name: bfgminer-proxy-testnet
    depends_on:
      - bitcoin-testnet
    restart: unless-stopped
    command: >
      bfgminer -S noauto -o http://bitcoin-testnet:18332 -O ${RPC_USER_TESTNET}:${RPC_PASSWORD_TESTNET}
      --stratum-port 13333 --coinbase-addr ${PAYOUT_ADDRESS_TESTNET}
      --no-getwork --no-monitor --no-submit-stale
    env_file: .env
    ports:
      - "13333:13333" # Stratum testnet

  # ---------- CKPool (MAINNET) ----------
  ckpool-main:
    image: pinkyswear/ckpool-solo:latest
    container_name: ckpool-solo-main
    depends_on:
      - bitcoin-main
    restart: unless-stopped
    volumes:
      - ./ckpool/ckpool.mainnet.conf:/srv/ckpool/ckpool.conf:ro
    ports:
      - "3334:3333"   # expose as 3334 (container listens 3333)

  # ---------- CKPool (TESTNET) ----------
  ckpool-test:
    image: pinkyswear/ckpool-solo:latest
    container_name: ckpool-solo-testnet
    depends_on:
      - bitcoin-testnet
    restart: unless-stopped
    volumes:
      - ./ckpool/ckpool.testnet.conf:/srv/ckpool/ckpool.conf:ro
    ports:
      - "13334:3333"  # expose as 13334 (container listens 3333)
