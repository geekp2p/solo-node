# syntax=docker/dockerfile:1

FROM debian:bookworm-slim AS builder

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       ca-certificates \
       build-essential \
       autoconf \
       automake \
       libtool \
       pkg-config \
       libevent-dev \
       libjansson-dev \
       libssl-dev \
       libcurl4-openssl-dev \
       uthash-dev \
       dos2unix \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src

# ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå ckpool ‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô src/ ‡∏Ç‡∏≠‡∏á context
# (‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡∏°‡∏≤)
COPY src/ /src

RUN if [ ! -f /src/autogen.sh ]; then \
        echo "ckpool sources are missing. Run ./ckpool/fetch-source.sh before building." >&2; \
        exit 1; \
    fi && \
    rm -f /src/.gitkeep && rm -rf /src/.git

# üîß FIX ‡∏´‡∏•‡∏±‡∏Å: ‡πÅ‡∏õ‡∏•‡∏á CRLF -> LF ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå autotools ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ô autogen
RUN mkdir -p m4 \
    && find . -type f \( -name '*.m4' -o -name '*.ac' -o -name '*.am' -o -name '*.sh' \) -exec dos2unix {} + \
    && chmod +x autogen.sh \
    && ./autogen.sh \
    && ./configure \
    && make -j"$(nproc)"

FROM debian:bookworm-slim

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       ca-certificates \
       libevent-2.1-7 \
       libjansson4 \
       libssl3 \
       libcurl4 \
    && rm -rf /var/lib/apt/lists/*

# ckpool's autotools tree outputs the binary under src/ckpool relative to the
# repository root, so grab that path from the builder stage.
COPY --from=builder /src/src/ckpool /usr/local/bin/ckpool
COPY run-ckpool.sh /usr/local/bin/run-ckpool
RUN chmod +x /usr/local/bin/run-ckpool

ENTRYPOINT ["ckpool"]
CMD ["-h"]
